@page
@model Bankapp.Pages.Accounts.DetailsModel
@{
    ViewData["Title"] = "Kontodetaljer";
}

<section class="page-section bg-light">
    <div class="container">
        <div class="text-center mb-4">
            <h2 class="section-heading text-uppercase">Kontobild</h2>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Konto @Model.Account.AccountId</h5>
                <p><strong>Saldo:</strong> @Model.Account.Balance.ToString("C")</p>
                <p><strong>Frekvens:</strong> @Model.Account.Frequency</p>
            </div>
        </div>

        <a class="btn btn-secondary mb-3" href="/Customers/Search">Tillbaka till kundsök</a>

        <h5>Transaktioner</h5>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Typ</th>
                    <th>Operation</th>
                    <th>Belopp</th>
                    <th>Saldo efter transaktion</th>
                </tr>
            </thead>
            <tbody id="transactionRows">
                @foreach (var tx in Model.Account.Transactions)
                {
                        <tr>
                            <td>@tx.Date.ToString("yyyy-MM-dd")</td>
                            <td>@tx.Type</td>
                            <td>@tx.Operation</td>
                            <td>@tx.Amount.ToString("C")</td>
                            <td>
                            @if (tx.Balance == 0)
                            {
                                        <span class="text-muted">0</span>
                            }
                            else
                            {
                                @tx.Balance.ToString("C")
                            }
                            </td>
                        </tr>
                }
            </tbody>
        </table>

        @if (Model.Account.Transactions.Count < Model.Account.TotalTransactionCount)
        {
                <button class="btn btn-primary" id="loadMoreBtn"
                        data-account="@Model.Account.AccountId"
                        data-skip="@Model.Account.Transactions.Count">
                    Ladda fler transaktioner
                </button>
        }
    </div>
</section>

@section Scripts {
    <script>
        document.getElementById("loadMoreBtn")?.addEventListener("click", function () {
            var button = this;
            var accountId = button.getAttribute("data-account");
            var skip = parseInt(button.getAttribute("data-skip"));

            fetch(`/Accounts/Details?handler=LoadMoreTransactions&accountId=${accountId}&skip=${skip}`)
                .then(response => response.text())
                .then(html => {
                    var tableBody = document.getElementById("transactionRows");
                    tableBody.insertAdjacentHTML('beforeend', html);
                    button.setAttribute("data-skip", skip + 20);

                    var total = @Model.Account.TotalTransactionCount;
                    if (skip + 20 >= total) {
                        button.remove();
                    }
                })
                .catch(error => console.error('Fel vid laddning:', error));
        });
    </script>
}

